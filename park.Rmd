Markdown Parking Area: Stuff in this file was removed from one of the Markdown files and contains all the graph objects not in use for now:
03_forecasts.Rmd
```{r forecasts, echo=FALSE, cache=FALSE}
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
##                      Build Forecast for every Journey                  ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
options(scipen = 999)

journey_unique_names <- journey_segments %>% select(journey_name) %>% distinct()
journey_unique_count <- nrow(journey_unique_names)

# Predictor = Control Group (Pre Launch Data)
forecast_datalist = list()
for (i in 1:nrow(journey_unique_names)) {
  forecast_data <- journey_data %>%
    select(Day, journey_name, Visits) %>%
    group_by(journey_name) %>%
    arrange(desc(journey_name), Day) %>%
    filter(journey_name == journey_unique_names$journey_name[i]) %>%
    filter(Day >= pre_start_date & Day <= post_end_date)

  # Get the first and last row dates of the available data
  forecast_start_date = head(forecast_data$Day, n = 1)
  forecast_end_date = tail(forecast_data$Day, n = 1)
  forecast_pre_date_range = c(as.Date(forecast_start_date), as.Date(pre_end_date))
  forecast_post_date_range = c(as.Date(post_start_date), as.Date(forecast_end_date))

  time.points <- as.Date(seq(forecast_start_date, forecast_end_date, by = "day"))

  data <- zoo(cbind(forecast_data$Visits), time.points)
  forecast_data <- CausalImpact(data, as.Date(forecast_pre_date_range), as.Date(forecast_post_date_range), model.args = list(season.duration = 1))

  gg <- plot(forecast_data, c("original", "pointwise"))
  plotname <- paste0(journey_unique_names$journey_name[i])

  print(gg + ggplot2::ggtitle(plotname))

  forecast_datalist[[i]] <- forecast_data
}

# Write out to a .csv for use if the script craps out and put a message to the console
message("Forecast processing completed.")
```

```{r dumbell_1, echo=FALSE, fig.height=7, fig.width=9, warning=FALSE}
db1
```


```{r change_relative, echo=FALSE,fig.height=7, fig.width=9}
ggplotly(p1)
```

```{r boxplot1, ECHO=FALSE,fig.height=7, fig.width=9}
ggplotly(c1)
```

```{r boxplot2, ECHO=FALSE,fig.height=7, fig.width=9}
ggplotly(r1)
```

```{r changes_overtime, ECHO=FALSE,fig.height=7, fig.width=9}
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
##             Build the Daily Comparison of Journey Changes Table          ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

compare_day <- journey_data %>% 
  select(Day, journey_type, journey_name, Visits, category, sub_category) %>% 
  group_by(journey_name) %>%
  right_join(baseline, by.x = C("journey_name" = "journey_name","journey_type" = "journey_type")) %>% 
  select(Day, journey_type, journey_name, Visits, Visits_mean, category, sub_category) %>% 
  rename(baseline_pre = Visits_mean) 

compare_baseline <- compare_day %>% filter(journey_type == "pre") %>% 
  select(journey_name, baseline_pre, sub_category) %>% group_by(journey_name) %>% distinct()

compare_yesterday <- compare_day %>% filter(Day == yesterday & journey_type == "post") %>%
  mutate(visits_yest = mean(Visits)) %>% select(journey_name, visits_yest) %>% distinct()

compare_3_day <- compare_day %>% filter(Day >= three_days_ago & Day < last_valid_date & journey_type == "post") %>%
  mutate(visits_3_da = mean(Visits)) %>% select(journey_name, visits_3_da) %>% distinct()

compare_7_day <- compare_day %>% filter(Day >= seven_days_ago & Day < last_valid_date & journey_type == "post") %>%
  mutate(visits_7_da = mean(Visits)) %>% select(journey_name, visits_7_da) %>% distinct()

compare_14_day <- compare_day %>% filter(Day >= fourteen_days_ago & Day < last_valid_date & journey_type == "post") %>%
  mutate(visits_14_da = mean(Visits)) %>% select(journey_name, visits_14_da) %>% distinct()

compare_to_day <- compare_baseline %>% 
  right_join(compare_14_day, by = "journey_name") %>% 
  right_join(compare_7_day, by = "journey_name") %>% 
  right_join(compare_3_day, by = "journey_name") %>% 
  right_join(compare_yesterday, by = "journey_name") %>% 
  relocate(sub_category, .after = journey_name)

##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
##           Parallel Plot Graph Comparing Journey Changes Over Time        ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Facet wrap all journey comparisons
sl1 <- compare_to_day %>%
  arrange(desc(journey_name)) %>% rename('Baseline' = baseline_pre, 
                                         '14 Day Avg' = visits_14_da, 
                                         '7 Day Avg' = visits_7_da, 
                                         '3 Day Avg' = visits_3_da,  
                                         'Yesterday' = visits_yest) %>% 
  ggparcoord(
    columns = 3:ncol(compare_to_day), groupColumn = 1,
    alphaLines = 0.9,    
    splineFactor = TRUE,
    scale = "globalminmax",
    #scale="std",
    showPoints = TRUE, 
    title = "Journey Changes over Time",
    mapping = ggplot2::aes_string(x = "`All Journeys`", y = "Visits")
  ) +
  theme(
    plot.title = element_text(size=10),
    legend.position = "none"
  ) +
  facet_wrap(vars(journey_name), scales = "free", ncol = 5L)


# Specific Journeys
sl2 <- compare_to_day %>%
  filter(journey_name %in% c("ALL Apple iOS", "ALL Visits", "ALL SEO", "Days Out Entry")) %>% 
  arrange(desc(journey_name)) %>% rename('Baseline' = baseline_pre, 
                                         '14 Day Avg' = visits_14_da, 
                                         '7 Day Avg' = visits_7_da, 
                                         '3 Day Avg' = visits_3_da, 
                                         'Yesterday' = visits_yest) %>% 
  ggparcoord(
    columns = 3:ncol(compare_to_day), groupColumn = 1,
    alphaLines = 0.9,    
    splineFactor = TRUE,
    scale = "globalminmax",
    #scale="std",
    showPoints = TRUE, 
    title = "Journey Changes over Time",
    mapping = ggplot2::aes_string(x = "Journeys", y = "Visits")
  ) +
  theme(
    plot.title = element_text(size=10),
    legend.position = "none"
  ) +
  facet_wrap(vars(journey_name), scales = "free", ncol = 5L)


# Sub Category Group of Pages
sl3 <- compare_to_day %>%
 # filter(sub_category %in% c("landing_pages")) %>% 
  arrange(desc(journey_name)) %>% rename('Baseline' = baseline_pre, 
                                         '14 Day Avg' = visits_14_da, 
                                         '7 Day Avg' = visits_7_da, 
                                         '3 Day Avg' = visits_3_da,  
                                         'Yesterday' = visits_yest) %>% 
  ggparcoord(
    columns = 3:ncol(compare_to_day), groupColumn = 1,
    alphaLines = 0.9,    
    splineFactor = TRUE,
    scale = "globalminmax",
    #scale="std",
    showPoints = TRUE, 
    title = "Journey Changes over Time",
    mapping = ggplot2::aes_string(x = "`Landing Page Journey`", y = "Visits")
  ) +
  theme(
    plot.title = element_text(size=10),
    legend.position = "none"
  ) +
  facet_wrap(vars(journey_name), scales = "free")

ggplotly(sl1)
ggplotly(sl2)
ggplotly(sl3)


c1 <- relative_change %>%
  filter(str_detect(journey_name,"Commercial")) %>%
  ggplot() +
  aes(x = journey_name, y = Visits, fill = journey_type) +
  geom_boxplot(shape = "circle") +
  scale_fill_hue(direction = 1) +
  labs(x = "Journey Name", y = "Visits", title = "Journey Pre & Post Comparison", 
       subtitle = "Box Plot") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold"))

##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
##                      Box Plot - Journey Pre/Post Comparison               ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



r1 <- relative_change %>%
  filter(!(sub_category %in% c("social", "shop", "holidays"))) %>%
  ggplot() +
  aes(x = sub_category, y = Visits, fill = journey_type) +
  geom_boxplot(shape = "circle") +
  scale_fill_hue(direction = 1) +
  labs(x = "Journey Category", y = "Visits", title = "Journey Categorisations", 
       subtitle = "Grouped Journeys") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold"))
r1

##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
##              Percentage Change Relative to the Baseline Summary          ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

p1 <- relative_change %>%
  filter(journey_name %in% c("ALL Mobile", "ALL Visits", "ALL Tablet", "ALL SEO")) %>%
  ggplot() +
  aes(x = Day, y = diff_to_mean, colour = journey_name) +
  geom_line(size = 0.5) +
  geom_vline(xintercept = as.numeric(as.Date(post_start_date)), color = "red", linetype=4, lwd = .8, alpha=0.5) +
  geom_hline(yintercept=0, linetype=3, col = 'blue', lwd = .8, alpha=0.5) +
  scale_color_hue(direction = 1) +
  labs(
    x = "90 Days Pre & 90 Days Post",
    y = "% Change Relative to Baseline",
    title = "Percentage Change Relative to Baseline",
    subtitle = "Baseline Pre & Post CMS Launch",
    caption = "% Change Relative to Baseline"
  ) +
  theme_bw() +
  scale_y_continuous(labels = percent) +
  facet_wrap(vars(journey_name), scales = "free", ncol = 2L) +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold"))

#p1
```


The following are some highlights.

### Most Popular Journeys


Top 10
Good
Bad

Number of Journeys Higher or Lower than Baseline

Dumbbell plots
Parallel Plot - Top 10 good/bad

Most common user journeys though the website

### Entry Journeys/Inbound Journeys

How are Entry journeys affected by the changes

### Search Rankings
### Research Visits 
### Conversion Rates (All Funnels)
### Compare Benchmarks
#### Number of sessions per user
#### New vs. returning users
#### Pages per session
#### Average page time
#### Organic traffic
#### Google Trends
### Devices

Device journeys and any gaps

### Journey Category

Journeys grouped by their category and measures

### Baseline Detailed View By Journey

Below is the detail behind each journey and main traffic metrics for each journey.



```{r}
library(ggbump)
pacman::p_load(tidyverse, cowplot, wesanderson)

df <- tibble(country = c("India", "India", "India", "Sweden", "Sweden", "Sweden", "Germany", "Germany", "Germany", "Finland", "Finland", "Finland"),
             year = c(2011, 2012, 2013, 2011, 2012, 2013, 2011, 2012, 2013, 2011, 2012, 2013),
             value = c(492, 246, 246, 369, 123, 492, 246, 369, 123, 123, 492, 369))

knitr::kable(head(df))

df <- df %>% 
  group_by(year) %>% 
  mutate(rank = rank(value, ties.method = "random")) %>% 
  ungroup()

knitr::kable(head(df))

ggplot(df, aes(year, rank, color = country)) +
    geom_bump()


ggplot(df, aes(year, rank, color = country)) +
  geom_point(size = 7) +
  geom_text(data = df %>% filter(year == min(year)),
            aes(x = year - .1, label = country), size = 5, hjust = 1) +
  geom_text(data = df %>% filter(year == max(year)),
            aes(x = year + .1, label = country), size = 5, hjust = 0) +
  geom_bump(size = 2, smooth = 8) +
  scale_x_continuous(limits = c(2010.6, 2013.4),
                     breaks = seq(2011, 2013, 1)) +
  theme_minimal_grid(font_size = 14, line_size = 0) +
  theme(legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "RANK",
       x = NULL) +
  scale_y_reverse() +
  scale_color_manual(values = wes_palette(n = 4, name = "GrandBudapest1"))


```


# df <- db_plot_data %>% 
#   mutate(journey_name = fct_reorder(journey_name, diff_vs_baseline, .desc = TRUE)) %>% 
#   arrange(diff_vs_baseline) 
# 
# ggplot(df) +
#   aes(x = journey_name, fill = change, weight = diff_vs_baseline) +
#   geom_bar() +
#   scale_fill_hue(direction = -1) +
#   labs(x = "d", y = "e", title = "a", subtitle = "b", caption = "c", 
#        fill = "f") +
#   coord_flip() +
#   ggthemes::theme_pander()