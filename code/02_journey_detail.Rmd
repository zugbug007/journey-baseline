
```{r top10,echo=FALSE}
ggplotly(top10)
```

```{r bottom10,echo=FALSE}
ggplotly(bot10)
```

```{r highlow,echo=FALSE}
ggplotly(highlow_count)
```

### Baseline Summary

Below is a summary of the website journeys looking at data from **`r pre_start_date` to `r post_end_date`**. 
This table is sorted by the difference between the baseline and the new site baseline difference percentage.
Poor performing new journeys should come to the top.

```{r baseline, echo=FALSE}
baseline_visits_mean <- baseline_summary %>% 
  select(journey_name, Visits_mean.a.pre, Visits_mean.b.post) %>% 
  mutate(visits_diff = round(((Visits_mean.b.post - Visits_mean.a.pre)/Visits_mean.a.pre)*100, digits = 1)) %>% 
  arrange(visits_diff) %>% 
  top_n(-10, visits_diff) %>% 
  kable(col.names = c("Journey Name", "Baseline Visits", "New Site Visits Avg.", "% Visits Diff.")) %>% kable_styling(bootstrap_options = c("striped", "condensed"))

baseline_visits_mean

```

### Anomaly Analysis By Journey
Below is the count of anomalies detected for each journey, this is sorted by the number detected in the post launch period.
Journeys higher up this list will need more investigation than lower journeys.

```{r, echo=FALSE,fig.height=7, fig.width=9}
# Build Cont Table of Anomalies for each journey. Get the number POST change so identify biggest differences after the cut over.

anomaly_count
```

### Anomaly Plots By Journey
Baseline Dates: **`r pre_start_date` to `r pre_end_date`**. 
Launch Dated (Red Line): **`r post_start_date` to `r post_end_date`**.

```{r anomaly_plots,echo=FALSE,fig.height=7, fig.width=9}
#Anomaly Plots for each journey with Ribbon and Pre/Post separations
for (i in 1:nrow(journey_unique_names)) {
plot_journey_name <- journey_unique_names$journey_name[i]    # Get the journey name
anomaly_subset <- anomaly_data %>% filter(journey_name == plot_journey_name & metric == 'visits')     # Subset the anomaly data for journey and metric
plot_metric_name <- anomaly_subset %>% filter(row_number()==1) %>% pull(metric)                       # Get the metric name from the first row
p2 <- anomaly_subset %>% dplyr::filter(metric == plot_metric_name & journey_name == plot_journey_name) %>%  # Use the subset to build the anomaly chart
  ggplot(aes_string(x = "day")) +
  geom_line(aes_string( y = 'data'), color="#69b3a2", size = 0.8) +
  geom_point(data = anomaly_data %>% dplyr::filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name),
                      aes_string(y ='data'),color="red", size = 1.8) +
  geom_ribbon(aes(ymin=dataLowerBound, ymax=dataUpperBound), alpha=0.2) +
  geom_vline(xintercept = as.numeric(as.Date(post_start_date)), color = "red", linetype='dotted', lwd = .8, alpha=0.5) +
  labs(title = plot_journey_name,
                subtitle = paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.'),
                caption =paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.')) +
  theme_bw() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = 'none') +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold")) +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(y=0) +
  ylab("Visits") +
  facet_wrap(~journey_name, dir = "v")
print(p2)
}
```

### Heatmaps 
Insights:


```{r journey_heatmap, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
# OrRd, RdYlGn, BuPu, Blues, Greens, Greys,GnBu, PuBuGn, PuRd, RdPu, YlGn,YlGnBu, YlOrBr, YlOrRd, Oranges, Purples, Reds
library(d3heatmap)
d3heatmap(heatmap_visits_by_day, dendrogram = 'none', key = FALSE, col = 'RdYlGn', 
          labRow = heatmap_visits_by_day$journey_name, labColSize = 3,
          scale = 'row', key.title = "Legend", print.values = F,
          notecol = 'red') %>% 
  hmAxis("x", title = "Day", location = 'bottom', angle = 90) %>% 
  hmAxis("y", title = "Journey", location = 'left') %>% 
  hmCells(font.size = 10, color = 'blue') %>% 
  hmLegend(show = F, title = "Title", location = "tl")

# d3heatmap(heatmap_anomalies_by_day, dendrogram = 'none', key = FALSE, col = 'RdPu', 
#             labRow = heatmap_anomalies_by_day$journey_name, labColSize = 3,
#             scale = 'row', key.title = "Legend", print.values = F,
#             notecol = 'red') %>% 
#     hmAxis("x", title = "Day", location = 'bottom', angle = 90) %>% 
#     hmAxis("y", title = "Journey", location = 'left') %>% 
#     hmCells(font.size = 10, color = 'blue') %>% 
#     hmLegend(show = F, title = "Title", location = "tl")

```




