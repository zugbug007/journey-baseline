### How to use this document
pre/post date ranges & cut over period
Days since website launch
Example Graph with highlighted info



```{r dumbell_1, echo=FALSE}
db1
```

```{r change_relative, echo=FALSE}
ggplotly(p1)
```


```{r boxplot1, ECHO=FALSE}
ggplotly(c1)
```

```{r boxplot2, ECHO=FALSE}
ggplotly(r1)
```

```{r top10, ECHO=FALSE}
ggplotly(top10)
```

```{r bottom10, ECHO=FALSE}
ggplotly(bot10)
top10 + bot10
```

```{r highlow, ECHO=FALSE}
ggplotly(highlow_count)

```

```{r changes_overtime, ECHO=FALSE}
ggplotly(sl1)
ggplotly(sl2)
ggplotly(sl3)
```

The following are some highlights.

### Most Popular Journeys


Top 10
Good
Bad

Number of Journeys Higher or Lower than Baseline

Dumbbell plots
Parallel Plot - Top 10 good/bad

Most common user journeys though the website

### Entry Journeys/Inbound Journeys

How are Entry journeys affected by the changes

### Search Rankings
### Research Visits 
### Conversion Rates (All Funnels)
### Compare Benchmarks
#### Number of sessions per user
#### New vs. returning users
#### Pages per session
#### Average page time
#### Organic traffic

### Devices

Device journeys and any gaps

### Journey Category

Journeys grouped by their category and measures

### Baseline Summary

Below is a summary of the website journeys looking at data from **`r pre_start_date` to `r post_end_date`**. 
This table is sorted by the difference between the baseline and the new site baseline difference percentage.
Higher performing new journeys should come to the top while worst performing journeys should be at the bottom.

```{r baseline, echo=FALSE}
baseline_visits_mean <- baseline_summary %>% select(journey_name, Visits_mean.a.pre, Visits_mean.b.post) %>% 
  mutate(`% Visits Diff.` = percent(((Visits_mean.b.post - Visits_mean.a.pre)/Visits_mean.a.pre), accuracy = 0.1)) %>% arrange(desc(`% Visits Diff.`)) %>% 
    kable(col.names = c("Journey Name", "Baseline Visits", "New Site Visits Avg.", "% Visits Diff.")) %>% kable_styling(bootstrap_options = c("striped", "condensed"))
baseline_visits_mean

```

### Baseline Detailed View By Journey

Below is the detail behind each journey and main traffic metrics for each journey.

```{r, echo=FALSE}
baseline_flex_table %>% scroll_box(width = "100%", height = "400px")

```

### Anomaly Analysis By Journey
Below is the count of anomalies detected for each journey, this is sorted by the number detected in the post launch period.
Journeys higher up this list will need more investigation than lower journeys.

```{r, echo=FALSE}
# Build Cont Table of Anomalies for each journey. Get the number POST change so identify biggest differences after the cut over.

anomaly_count
```

### Anomaly Plots By Journey
Baseline Dates: **`r pre_start_date` to `r pre_end_date`**. 
Launch Dated (Red Line): **`r post_start_date` to `r post_end_date`**.

```{r,echo=FALSE}
# Anomaly Plots for each journey with Ribbon and Pre/Post separations
i = 0
for (i in 1:nrow(journey_unique_names)) {
plot_journey_name <- journey_unique_names$journey_name[i]    # Get the journey name
anomaly_subset <- anomaly_data %>% filter(journey_name == plot_journey_name & metric == 'visits')     # Subset the anomaly data for journey and metric
plot_metric_name <- anomaly_subset %>% filter(row_number()==1) %>% pull(metric)                       # Get the metric name from the first row
p2 <- anomaly_subset %>% dplyr::filter(metric == plot_metric_name & journey_name == plot_journey_name) %>%  # Use the subset to build the anomaly chart
  ggplot(aes_string(x = "day")) +
  geom_line(aes_string( y = 'data'), color="#69b3a2", size = 0.8) +
  geom_point(data = anomaly_data %>% dplyr::filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name),
                      aes_string(y ='data'),color="red", size = 1.8) +
  geom_ribbon(aes(ymin=dataLowerBound, ymax=dataUpperBound), alpha=0.2) +
  geom_vline(xintercept = as.numeric(as.Date(post_start_date)), color = "red", linetype='dotted', lwd = .8, alpha=0.5) +
  labs(title = plot_journey_name,
                subtitle = paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.'),
                caption =paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.')) +
  theme_bw() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = 'none') +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold")) +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(y=0) +
  facet_wrap(~journey_name, dir = "v")
print(p2)
}
```

