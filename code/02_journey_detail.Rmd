The following are some highlights.

### Most Popular Journeys


Top 10
Good
Bad

Number of Journeys Higher or Lower than Baseline

Dumbbell plots
Parallel Plot - Top 10 good/bad

Most common user journeys though the website

### Entry Journeys/Inbound Journeys

How are Entry journeys affected by the changes

### Search Rankings
### Research Visits 
### Conversion Rates (All Funnels)
### Compare Benchmarks
#### Number of sessions per user
#### New vs. returning users
#### Pages per session
#### Average page time
#### Organic traffic


### Commercial Funnels

#### National Trust Shop
Commercial funnel steps through each major revenue focused commercial area.
Shop Average daily funnel event stages 1 to 4. Comparison is based on a rolling 7 day window.
Start: **`r start_14_days_ago_days` to `r end_7_days_ago`**. 
```{r}

# Journey Data steps, build each table based on shop, holidays, donate, membership event funnels.
# Before and after next to each other using patchwork. 
# Currently baseline for thi starts 14 days ago for the 7 days after. comparison starts 7 days back from today.
shop_funnel_pre <- journey_data %>% 
  filter(journey_name == "Commercial: Shop Checkout Steps 1-4") %>% 
  select(Day, journey_name, journey_type, contains("Shop")) %>% 
  filter(Day >= start_14_days_ago_days & Day <= end_7_days_ago) %>% arrange(Day) %>% 
    summarise(across(c(`Shop - Order Step 1 - Basket (ev179)`,`Shop - Order Step 2 - Delivery Details (ev180)`,`Shop - Order Step 3 - Payment Details (ev181)`,`Shop - Order Step 4 - Order Confirmation (Serialized) (ev182)`), list(mean = mean), .names = "{.col}_{.fn}")) %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  c(., recursive=TRUE)

shop_funnel_post <- journey_data %>% 
  filter(journey_name == "Commercial: Shop Checkout Steps 1-4") %>% 
  select(Day, journey_name, journey_type, contains("Shop")) %>% 
  filter(Day >= Sys.Date() - 7 & Day <= Sys.Date() - 1) %>% arrange(Day) %>% 
    summarise(across(c(`Shop - Order Step 1 - Basket (ev179)`,`Shop - Order Step 2 - Delivery Details (ev180)`,`Shop - Order Step 3 - Payment Details (ev181)`,`Shop - Order Step 4 - Order Confirmation (Serialized) (ev182)`), list(mean = mean), .names = "{.col}_{.fn}")) %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  c(., recursive=TRUE)

shop_fun_pre_plot <- plot_ly() 
shop_fun_pre_plot <- shop_fun_pre_plot %>%
  add_trace(
  type = "funnel",
  y = c("Order Step 1 - Basket", "Order Step 2 - Delivery Details", "Order Step 3 - Payment Details", "Order Step 4 - Order Confirmation"),
  x = shop_funnel_pre)
shop_fun_pre_plot <- shop_fun_pre_plot %>%
  layout(yaxis = list(categoryarray = c("Order Step 1 - Basket", "Order Step 2 - Delivery Details", "Order Step 3 - Payment Details", "Order Step 4 - Order Confirmation")))
shop_fun_pre_plot

```
```{r}
shop_fun_post_plot <- plot_ly() 
shop_fun_post_plot <- shop_fun_post_plot %>%
  add_trace(
  type = "funnel",
  y = c("Order Step 1 - Basket", "Order Step 2 - Delivery Details", "Order Step 3 - Payment Details", "Order Step 4 - Order Confirmation"),
  x = shop_funnel_post)
shop_fun_post_plot <- shop_fun_post_plot %>%
  layout(yaxis = list(categoryarray = c("Order Step 1 - Basket", "Order Step 2 - Delivery Details", "Order Step 3 - Payment Details", "Order Step 4 - Order Confirmation")))
shop_fun_post_plot
```


### Devices

Device journeys and any gaps

### Journey Category

Journeys grouped by their category and measures

### Baseline Summary

Below is a summary of the website journeys looking at data from **`r pre_start_date` to `r post_end_date`**. 
This table is sorted by the difference between the baseline and the new site baseline difference percentage.
Higher performing new journeys should come to the top while worst performing journeys should be at the bottom.

```{r baseline, echo=FALSE}
pre_baseline <- journey_data %>% filter(journey_type=="pre") %>% 
  group_by(journey_name) %>% 
  summarise(across(c(`Visits`,`Page Views`, `Unique Visitors`, `Bounces`,`Average Time Spent on Site (seconds)` , `% New Visits`,	`% Repeat Visits`,	`New Visits`,	`Repeat Visits`), list(mean = mean), .names = "{.col}_{.fn}")) %>% 
  add_column(journey_type = "pre", .after = "journey_name") %>% 
  mutate(`% New Visits_mean` = percent(`% New Visits_mean`, accuracy = 0.1)) %>% 
  mutate(`% Repeat Visits_mean` = percent(`% Repeat Visits_mean`, accuracy = 0.1)) %>% mutate(across(where(is.numeric), round, 0))


post_baseline <- journey_data %>% filter(journey_type=="post") %>% 
  group_by(journey_name) %>% 
  summarise(across(c(`Visits`,`Page Views`, `Unique Visitors`, `Bounces`,`Average Time Spent on Site (seconds)` ,`% New Visits`,	`% Repeat Visits`,	`New Visits`,	`Repeat Visits`), list(mean = mean), .names = "{.col}_{.fn}")) %>% 
  add_column(journey_type = "post", .after = "journey_name") %>% 
  mutate(`% New Visits_mean` = percent(`% New Visits_mean`, accuracy = 0.1)) %>% 
  mutate(`% Repeat Visits_mean` = percent(`% Repeat Visits_mean`, accuracy = 0.1)) %>% mutate(across(where(is.numeric), round, 0))

baseline <- rbind(pre_baseline, post_baseline)
baseline_flex_table <- baseline %>% arrange(journey_name) %>% 
    kable(col.names = c("Journey Name", "Journey Type", "Visits Avg.", "Page Views Avg.", "UV Avg.", "Bounces Avg.", "Avg. Time on Site", "Avg. % New Visits", "Avg. % Repeat Visits", "Avg New Visits", "Avg. Repeat Visits")) %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"))


baseline_summary <- pre_baseline %>% full_join(post_baseline, by = c("journey_name" = "journey_name"), suffix =c(".a.pre", ".b.post")) %>% select(-journey_type.a.pre, -journey_type.b.post) %>% select(journey_name, order(colnames(.))) 
baseline_visits <- baseline_summary %>% select(journey_name, contains("Visits"))

baseline_visits_mean <- baseline_summary %>% select(journey_name, Visits_mean.a.pre, Visits_mean.b.post) %>% 
  mutate(`% Visits Diff.` = percent(((Visits_mean.b.post - Visits_mean.a.pre)/Visits_mean.a.pre), accuracy = 0.1)) %>% arrange(desc(`% Visits Diff.`)) %>% 
    kable(col.names = c("Journey Name", "Baseline Visits", "New Site Visits Avg.", "% Visits Diff.")) %>% kable_styling(bootstrap_options = c("striped", "condensed"))
baseline_visits_mean

```

### Baseline Detailed View By Journey

Below is the detail behind each journey and main traffic metrics for each journey.

```{r, echo=FALSE}
baseline_flex_table %>% scroll_box(width = "100%", height = "400px")

```

### Anomaly Analysis By Journey
Below is the count of anomalies detected for each journey, this is sorted by the number detected in the post launch period.
Journeys higher up this list will need more investigation than lower journeys.

```{r, echo=FALSE}
# Build Cont Table of Anomalies for each journey. Get the number POST change so identify biggest differences after the cut over.
anomaly_count <- anomaly_data %>% filter(dataAnomalyDetected == T & journey_type == "post") %>% count(journey_name, journey_desc, dataAnomalyDetected) %>% 
  select(-dataAnomalyDetected) %>% arrange(desc(n)) %>% 
    kable(col.names = c("Journey Name", "Journey Description", "No. of Anomalies (Post Launch)")) %>% kable_styling(bootstrap_options = c("striped", "condensed", full_width = F)) #%>% scroll_box(width = "100%", height = "400px")
anomaly_count
```

### Anomaly Plots By Journey
Baseline Dates: **`r pre_start_date` to `r pre_end_date`**. 
Launch Dated (Red Line): **`r post_start_date` to `r post_end_date`**.

```{r,echo=FALSE}
# Anomaly Plots for each journey with Ribbon and Pre/Post separations
i = 0
for (i in 1:nrow(journey_unique_names)) {
  
plot_journey_name <- journey_unique_names$journey_name[i]    # Get the journey name
anomaly_subset <- anomaly_data %>% filter(journey_name == plot_journey_name & metric == 'visits')     # Subset the anomaly data for journey and metric
plot_metric_name <- anomaly_subset %>% filter(row_number()==1) %>% pull(metric)                       # Get the metric name from the first row
p2 <- anomaly_subset %>% dplyr::filter(metric == plot_metric_name & journey_name == plot_journey_name) %>%  # Use the subset to build the anomaly chart
  ggplot(aes_string(x = "day")) +
  geom_line(aes_string( y = 'data'), color="#69b3a2", size = 0.8) +
  geom_point(data = anomaly_data %>% dplyr::filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name),
                      aes_string(y ='data'),color="red", size = 1.8) +
  geom_ribbon(aes(ymin=dataLowerBound, ymax=dataUpperBound), alpha=0.2) +
  geom_vline(xintercept = as.numeric(as.Date(post_start_date)), color = "red", linetype='dotted', lwd = .8, alpha=0.5) +
  labs(title = plot_journey_name,
                subtitle = paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.'),
                caption =paste0('There are ',nrow(anomaly_data %>% filter(metric == plot_metric_name & dataAnomalyDetected == T & journey_name == plot_journey_name)), ' anomalies.')) +
  theme_bw() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = 'none') +
  theme(axis.title.y = element_text(face = "bold"), axis.title.x = element_text(face = "bold")) +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(y=0) +
  facet_wrap(~journey_name, dir = "v")
print(p2)
}
```

