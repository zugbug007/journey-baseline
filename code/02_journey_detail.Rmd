### Journey Performance

```{r top_bot_journeys, echo=FALSE, fig.height=7, fig.width=9}
  top_bot
```

### Baseline Summary

Below is a summary of the website journeys looking at data from **`r format(pre_start_date, "%b %d")` to `r format(last_valid_date, "%b %d")`**.  
This table is sorted by the difference between the baseline and the new site baseline difference percentage.
Poor performing new journeys should come to the top.

```{r baseline, echo=FALSE}
baseline_visits_mean <- baseline_summary %>% 
  select(journey_name, Visits_mean.a.pre, Visits_mean.b.post) %>% 
  mutate(visits_diff = round(((Visits_mean.b.post - Visits_mean.a.pre)/Visits_mean.a.pre)*100, digits = 1)) %>% 
  arrange(visits_diff) %>% 
  top_n(-10, visits_diff) %>% 
  kable(col.names = c("Journey Name", "Baseline Visits", "New Site Visits Avg.", "% Visits Diff.")) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = F)

baseline_visits_mean

```

Below is a summary of the total number of journeys which are higher or lower than their baseline.

```{r summary_table_high_low, echo=FALSE}

high_low_table

```


### Journey Heatmap

```{r journey_heatmap, echo=FALSE, fig.height=10, fig.width=13, message=FALSE, warning=FALSE}
# OrRd, RdYlGn, BuPu, Blues, Greens, Greys,GnBu, PuBuGn, PuRd, RdPu, YlGn,YlGnBu, YlOrBr, YlOrRd, Oranges, Purples, Reds, Set1

library (d3heatmap)
#'YlOrRd'
   d3heatmap(heatmap_visits_by_day, 
             dendrogram = 'none', 
             key = TRUE, 
             key.location = "fl",
             col = 'YlOrRd', 
             keysize = 1,
             key.title = "Visit Volume",
             labRow = heatmap_visits_by_day$journey_name, 
             labRowSize = 150, 
             scale = 'row',
             scale.by.range = TRUE,
             print.values = F,          
             show_grid = TRUE,
             anim_duration = 250, 
             cellnote_val = "Visits") %>% 
  hmAxis("x", title = "Day", location = 'bottom', angle = 90, font.size = '6px') %>% 
  hmAxis("y", title = "Journey Name", location = 'right', font.size = '10px') %>% 
  hmCells(font.size = 10)# %>% 
  #hmLegend(show = T, title = "Title", location = "tl")
  
  # d3heatmap(heatmap_anomalies_by_day, dendrogram = 'none', key = FALSE, col = 'RdPu',
  #            labRow = heatmap_anomalies_by_day$journey_name, labColSize = 3,
  #            scale = 'row', key.title = "Legend", print.values = F,
  #            notecol = 'red') %>%
  #    hmAxis("x", title = "Day", location = 'bottom', angle = 90) %>%
  #    hmAxis("y", title = "Journey", location = 'left') %>%
  #    hmCells(font.size = 10, color = 'blue') %>%
  #    hmLegend(show = F, title = "Title", location = "tl")
  detach("package:d3heatmap", unload = TRUE)  

```


### Anomaly Analysis By Journey
Below is the count of anomalies detected for each journey, this is sorted by the number detected in the post launch period.
Journeys higher up this list will need more investigation than lower journeys.  

Positive anomalies are where the visit data exceeded the upper boundary of the data window.
Negative anomalies are where the visit data fell below the lower boundary of the data window.
The Net value is an overall count of the anomalies: (Positive Anomalies - Negative Anomalies = Net).

Higher negative values for Net columns indicate the journey fell below the expected amounts for the journey. 
1 Anomaly = 1 day where the data was above or below expectations.

```{r anomaly_net_table, echo=FALSE, fig.height=7, fig.width=9}
# Build Cont Table of Anomalies for each journey. Get the number POST change so identify biggest differences after the cut over.

anomaly_count

```

### Page Metrics

In the table below:   
**Note:** All Shop & Holidays pages are filtered out of this report. This is for the National Trust Main Site only.

Page Data from: **`r format(last_valid_date-30, "%d-%b")` to `r format(last_valid_date, "%d-%b")`**.  
Total Pages: **`r nrow(page_data)`**.

* *[Page Name]* Page name of the Main site page. 
* *[Visits]* Visits made to the page in the time frame.    
* *[Page Views]* Page Views made to the page in the time frame.   
* *[Unique Visitors]* Unique Visits made to the page in the time frame. 
* *[Average Load Time]*  Calculation of the average Page Load time. Based on the Adobe Performance timing data.
* *[Average Time on Page]*  Calculation of the average time spent on a page.
* *[Bounce Rate]*  Bounce Rate of the page. Calculated from the Bounces divided by Entries to the page.
* *[Exit Rate]*  Percentage of users who this page was the last piece of content seen before leaving the site.

* *[Tip]* Use the sorting functions to filter the table.   
Looking for pages with long load times? Look for pages with more than 1000 page views or visits.



```{r page_analysis, echo=FALSE, fig.height=5, fig.width=7, fig.align='center',message=FALSE, warning=FALSE}

datatable(page_data, colnames = c('Page Name' = 2, 
                                  'Avg. Load Time (Sec)' = 6,
                                  'Avg. Time on Page (Sec)' = 7,
                                  'Bounce Rate %' = 8,
                                  'Exit Rate %' = 9), filter = 'top')

```


### Marketing Channels

Of the **`r df_marketing_channels %>% nrow()` marketing channels** that recorded visits:

-   `r mc_low`
-   `r mc_none`
-   `r mc_session_refresh`


```{r marketing_channels, echo=FALSE, fig.height=7, fig.width=9, fig.align='center',message=FALSE, warning=FALSE}
start_date <-  last_valid_date - 30
end_date <- last_valid_date
gg_marketing_channels <- ggplot(df_marketing_channels, aes(x = marketingchannel, y = visits, 
                                                           label = paste0(format(visits, big.mark = ",", trim = TRUE), " (",
                                                                          percent(pct_visits, accuracy = 0.1), ")"))) +
  geom_bar(stat = "identity", fill = "#009CAB") +
  geom_text(aes(y = visits + max(df_marketing_channels$visits) * 0.02), hjust = 0, size = 2.5, color = "gray30") +
  coord_flip() +
  scale_y_continuous(expand = c(0,0), limits = c(0, max(df_marketing_channels$visits) * 1.25)) +
  labs(title = "Visits by Marketing Channel",
       subtitle = paste0(rsid, ": ", start_date, " to ", end_date),
       caption = paste("Source: Adobe Analytics - RSID:", rsid, "-", start_date, "to", end_date)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(size = 11, color = "gray20"),
        plot.subtitle = element_text(size = 10, face = "italic", color = "gray40"),
        plot.caption = element_text(face = "italic", color = "gray40"),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank())

gg_marketing_channels

```

